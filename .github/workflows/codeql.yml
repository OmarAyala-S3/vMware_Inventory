name: "CodeQL Security Analysis"

on:
  push:
    branches: [ "main", "develop" ]
  pull_request:
    branches: [ "main", "develop" ]
  schedule:
    # Ejecuta todos los lunes a las 03:00 UTC
    - cron: '0 3 * * 1'
  workflow_dispatch:

jobs:
  analyze:
    name: Analyze Python — ${{ matrix.scan-type }}
    runs-on: ubuntu-latest

    permissions:
      security-events: write
      packages: read
      actions: read
      contents: read

    strategy:
      fail-fast: false
      matrix:
        include:
          # ── Escaneo de seguridad (vulnerabilidades criticas) ──────────────
          - scan-type: "Security"
            queries: security-extended

          # ── Escaneo de calidad (bugs, code smells, mejoras) ───────────────
          - scan-type: "Quality"
            queries: security-and-quality

    steps:
      # ── 1. Checkout ────────────────────────────────────────────────────────
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      # ── 2. Setup Python ────────────────────────────────────────────────────
      - name: Setup Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: "pip"

      # ── 3. Detectar ruta del proyecto y requirements ───────────────────────
      # Busca requirements.txt en cualquier subcarpeta del repo para que el
      # workflow funcione sin importar como este organizado el repositorio.
      - name: Detect project structure
        id: detect
        run: |
          REQ=$(find . -name "requirements.txt" \
                  -not -path "*/venv/*" \
                  -not -path "*/.git/*" \
                  -not -path "*/dist/*" \
                  -not -path "*/build/*" \
                  | head -1)

          if [ -n "$REQ" ]; then
            echo "requirements=$REQ" >> $GITHUB_OUTPUT
            echo "found_req=true"    >> $GITHUB_OUTPUT
            echo "Encontrado: $REQ"
          else
            echo "found_req=false"   >> $GITHUB_OUTPUT
            echo "No se encontro requirements.txt — continuando sin instalar dependencias"
          fi

          # Listar estructura del repo para debugging
          echo "--- Estructura del repositorio ---"
          find . -maxdepth 3 \
            -not -path "*/.git/*" \
            -not -path "*/venv/*" \
            -not -path "*/__pycache__/*" \
            | sort

      # ── 4. Instalar dependencias ───────────────────────────────────────────
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip

          # Instalar dependencias del proyecto si se encontro requirements.txt
          if [ "${{ steps.detect.outputs.found_req }}" = "true" ]; then
            pip install -r "${{ steps.detect.outputs.requirements }}" || true
          fi

          # Herramientas de analisis extra
          pip install bandit safety

      # ── 5. Bandit — analisis de seguridad especifico de Python ────────────
      - name: Run Bandit security scan
        if: matrix.scan-type == 'Security'
        run: |
          # Excluir venv, dist, build y archivos generados
          bandit -r . \
            --exclude ./.git,./venv,./.venv,./dist,./build \
            --severity-level medium \
            --confidence-level medium \
            --format sarif \
            --output bandit-results.sarif || true

          echo "Bandit completado."

      # ── 6. Safety — CVEs en dependencias de PyPI ──────────────────────────
      - name: Run Safety dependency check
        if: matrix.scan-type == 'Security'
        run: |
          if [ "${{ steps.detect.outputs.found_req }}" = "true" ]; then
            safety check \
              --file "${{ steps.detect.outputs.requirements }}" \
              --output text || true
          else
            echo "Sin requirements.txt — omitiendo Safety"
          fi

      # ── 7. Inicializar CodeQL ──────────────────────────────────────────────
      # IMPORTANTE: build-mode: none se define aqui directamente (no en matrix)
      # para evitar que el bloque config reactive el autobuild en CodeQL v4.
      - name: Initialize CodeQL
        uses: github/codeql-action/init@v4
        with:
          languages: python
          build-mode: none
          queries: ${{ matrix.queries }}
          # paths-ignore en config evita falsos positivos de venv y archivos generados.
          # NO se usa "paths:" aqui porque causaba el FileNotFoundError al buscar
          # la carpeta como punto de entrada del autobuild (linea 1256 del log).
          config: |
            paths-ignore:
              - "**/venv/**"
              - "**/.venv/**"
              - "**/dist/**"
              - "**/build/**"
              - "**/__pycache__/**"
              - "**/*.pyc"
              - "**/*.pyo"
            query-filters:
              - exclude:
                  tags contain: experimental

      # ── 8. Ejecutar analisis CodeQL ────────────────────────────────────────
      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v4
        with:
          category: "/language:python/scan:${{ matrix.scan-type }}"
          upload: always

      # ── 9. Subir resultados Bandit a pestaña Security ─────────────────────
      - name: Upload Bandit results to GitHub Security
        if: matrix.scan-type == 'Security' && hashFiles('bandit-results.sarif') != ''
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: bandit-results.sarif
          category: "bandit"

      # ── 10. Resumen del job en GitHub Actions ─────────────────────────────
      - name: Generate scan summary
        if: always()
        run: |
          echo "## CodeQL Scan Summary — ${{ matrix.scan-type }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Campo    | Valor |" >> $GITHUB_STEP_SUMMARY
          echo "|---|---|" >> $GITHUB_STEP_SUMMARY
          echo "| Tipo de scan | ${{ matrix.scan-type }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Queries  | ${{ matrix.queries }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Rama     | ${{ github.ref_name }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Commit   | \`${{ github.sha }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Trigger  | ${{ github.event_name }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Resultados en **Security → Code scanning alerts**" >> $GITHUB_STEP_SUMMARY

  # ── Reporte consolidado post-analisis ─────────────────────────────────────
  security-report:
    name: Security Report
    runs-on: ubuntu-latest
    needs: analyze
    if: always()

    permissions:
      contents: read
      security-events: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Final security summary
        run: |
          echo "## Resumen Final de Seguridad" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Herramientas ejecutadas" >> $GITHUB_STEP_SUMMARY
          echo "| Herramienta     | Descripcion                       | Cobertura          |" >> $GITHUB_STEP_SUMMARY
          echo "|---|---|---|" >> $GITHUB_STEP_SUMMARY
          echo "| CodeQL Security | Vulnerabilidades OWASP Top 10/CWE | Codigo fuente      |" >> $GITHUB_STEP_SUMMARY
          echo "| CodeQL Quality  | Bugs y malas practicas            | Codigo fuente      |" >> $GITHUB_STEP_SUMMARY
          echo "| Bandit          | Seguridad especifica de Python    | Codigo fuente      |" >> $GITHUB_STEP_SUMMARY
          echo "| Safety          | CVEs en dependencias              | requirements.txt   |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Alertas resueltas en este proyecto" >> $GITHUB_STEP_SUMMARY
          echo "- CWE-916: SHA-256 reemplazado por bcrypt en credentials.py y security.py" >> $GITHUB_STEP_SUMMARY
          echo "- CWE-327: Algoritmo de hashing debil en datos sensibles — corregido" >> $GITHUB_STEP_SUMMARY
          echo "- CWE-328: Hash de contrasena sin sal — corregido con bcrypt (sal automatica)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Ver alertas activas en: **Security → Code scanning**" >> $GITHUB_STEP_SUMMARY
